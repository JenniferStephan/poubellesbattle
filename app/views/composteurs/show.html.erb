<div class="composteur-box">
  <div class="composteur-left">
    <% if user_signed_in? %>
      <div class="referent-composteur-actions">
        <% if current_user.composteur_id == @composteur.id && current_user.role == "r√©f√©rent" %>
          <div class="dropdown dropdown-form-referent">
            <button class="btn referent-action-toggle" type="button" id="dropdownContact-members" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Ecrire √† mes Co-Composteur‚Ä¢euse‚Ä¢s
            </button>
            <div class="dropdown-menu referent-composteur-action" aria-labelledby="dropdownContact-members">
              <p>En tant que r√©f√©rent‚Ä¢e vous pouvez √©crire des messages √† tou‚Ä¢te‚Ä¢s les membres de <%= @composteur.name %>! Les membres recevront votre message par mail.</p>
              <%= simple_form_for @message do |f| %>
                <%= f.input :sender_email, input_html: { value: "#{current_user.email}", type: "hidden"} %>
                <%= f.input :sender_full_name, input_html: { value: "#{current_user.first_name.capitalize} #{current_user.last_name.capitalize}", type: "hidden"} %>
                <%= f.input :message_type, input_html: { value: "message-membres", type: "hidden"} %>
                <%= f.input :content, as: :text, placeholder: "Votre message..." %>
                <div class="center-form-submit"><%= f.submit "envoyer", class: "don-form-btn" %></div>
              <% end %>
            </div>
          </div>
          <div class="dropdown dropdown-form-referent">
            <button class="btn referent-action-toggle" type="button" id="dropdownContact-agglo" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Ecrire √† l'Equipe Poubelles Battle
            </button>
            <div class="dropdown-menu referent-composteur-action" aria-labelledby="dropdownContact-agglo">
              <p>En tant que r√©f√©rent‚Ä¢e vous pouvez √©crire directement √† l'Equipe Poubelles Battle. Votre message arrivera dans notre directement dans notre bo√Æte mail.</p>
              <%= simple_form_for @message do |f| %>
                <%= f.input :sender_email, input_html: { value: "#{current_user.email}", type: "hidden"} %>
                <%= f.input :sender_full_name, input_html: { value: "#{current_user.first_name.capitalize} #{current_user.last_name.capitalize}", type: "hidden"} %>
                <%= f.input :message_type, input_html: { value: "message-agglo", type: "hidden"} %>
                <%= f.input :content, as: :text, placeholder: "Votre message..." %>
                <div class="center-form-submit"><%= f.submit "envoyer", class: "don-form-btn" %></div>
              <% end %>
            </div>
          </div>
          <div class="dropdown dropdown-form-referent">
            <button class="btn referent-action-toggle" type="button" id="dropdownActions-retournement" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Date de retournement
            </button>
            <div class="dropdown-menu referent-composteur-action" aria-labelledby="dropdownActions-retournement">
              <p>En tant que r√©f√©rent‚Ä¢e vous pouvez modifier la date de retournement estim√©e du compost. Cette date sert √† calculer le remplissage de la jauge en dessous.</p>
              <%= simple_form_for @composteur do |f| %>
                <%= f.input :date_retournement, placeholder: "date de retournement :", as: :string, required: false, input_html: {class: "datepicker"} %>
                <div class="center-form-submit"><%= f.submit "mettre √† jour", class: "don-form-btn" %></div>
              <% end %>
            </div>
          </div>
          <div class="dropdown dropdown-form-referent">
            <button class="btn referent-action-toggle" type="button" id="dropdownActions-photo" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Modifier la photo
            </button>
            <div class="dropdown-menu referent-composteur-action" aria-labelledby="dropdownActions-photo">
              <p>En tant que r√©f√©rent‚Ä¢e vous pouvez modifier la modifier la photo de votre site de compostage.</p>
              <%= simple_form_for @composteur do |f| %>
                <%= f.input :photo, as: :file %>
                <div class="center-form-submit"><%= f.submit "mettre √† jour", class: "don-form-btn" %></div>
              <% end %>
            </div>
          </div>
        <% end %>
        <% if current_user.role == "admin" %>
          <div class="dropdown-form-referent">
            <div class="referent-action-toggle">
              <%= link_to "modifier", edit_composteur_path(@composteur) %>
            </div>
          </div>
        <% elsif current_user.role != "admin" %>
          <div class="dropdown-form-referent">
            <div class="referent-action-toggle">
              <% if current_user.composteur_id == nil %>
                <%= link_to("m'inscrire sur ce site !", inscription_path(@composteur), method: :post) %>
              <% elsif current_user.composteur_id == @composteur.id %>
                <%= link_to("me d√©sinscrire", desinscription_path(@composteur), method: :post) %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
    <h1><%= @composteur.name %></h1>
    <p><%= @composteur.address %></p>
    <p><%= @composteur.composteur_type %></p>
    <% if @composteur.photo.attached? %>
      <%= cl_image_tag @composteur.photo.key, height: 300, width: 400, crop: :fill %>
    <% else %>
      <%= image_tag 'PB_logo.png' %>
    <% end %>
    <div class="stats">
      <div class="users-count">
        <% if @users.count == 0 %>
          Personne n'est inscrit sur ce site de compostostage pour l'instant..
        <% elsif @users.count == 1 %>
          On dirait qu'il n'y a qu'un seul adepte du compostage inscrit..
        <% else %>
          D√©j√† <%= @users.count %> adeptes du compostages inscrit‚Ä¢e‚Ä¢s sur ce site !
        <% end %>
      </div>
      <!-- <div class="becoming-or-not-referent">

      </div> -->
    </div>
    <div class="les-users">
      <% @reversed_referents.each do |user| %>
        <div class="user-card" style="<% if user.role == "r√©f√©rent"%><%=  'background: darkorange' %><% end %>">
          <%= ["üßÖ","üçå","ü•¶","üçé","ü•®","ü•ñ","üçÅ","üåº"].sample %><%= user.first_name %>
        </div>
          <p class="round-counter"><%= user.notifications.count %></p>
      <% end %>
      <% @not_referents.each do |user| %>
        <div class="user-card" style="<% if user.role == "r√©f√©rent"%><%=  'background: darkorange' %><% end %>">
          <%= ["üßÖ","üçå","ü•¶","üçé","ü•®","ü•ñ","üçÅ","üåº"].sample %><%= user.first_name %>
        </div>
          <p class="round-counter"><%= user.notifications.count %></p>
      <% end %>

    </div>
      <!-- <p>Plus que <%#= Time.now - @composteur.installation_date.to_time %> jours avant que le compost soit pr√™t !</p> -->
      <% if @time_left > 0 %>
        <p>Plus que <%= @time_left %> jours avant que le compost soit pr√™t !</p>
      <% elsif @time_left == 0 %>
        <p>On dirait que la date du retournement du compost est arriv√©e !</p>
      <% else %>
        <p>Est-ce que la date de retournement est pass√©e ?</p>
      <% end %>
    <div class="compost-time-to-go">
      <div class="compost-time-past" style="
        <% if @time_left %>
            <%= "width: #{100 - @time_left/2}%;" %>
        <% end %> ">
      </div>

    </div>
    <% if user_signed_in? %>
      <% if current_user.composteur_id == @composteur.id || current_user.role == "admin" %>
        <h2 class="mt-5">Messagerie</h2>
        <p class="legende">cet espace priv√© vous permet d'√©changer avec les autres membres du site de compostage.</p>
        <% if current_user.role != "admin" %>
          <div class="depot-anomalie">
            <%= simple_form_for @notification, html: { class: "depot-form"} do |f| %>
              <%= f.input :notification_type, as: :string, input_html: { value: "depot", type:"hidden" }%>
              <%= f.input :content, as: :string, input_html: { value: "#{current_user.first_name} vient de faire un d√©pot !", type:"hidden" }%>
              <%= f.submit "J'ai fait un d√©pot !", class: "signaler depot" %>
            <% end %>
            <%= simple_form_for @notification, html: { class: "anomalie-form"} do |f| %>
              <%= f.input :notification_type, as: :string, input_html: { value: "anomalie", type:"hidden" }%>
              <%= f.input :content, collection: ["couvercle absent/ouvert", "outil manquant", "mati√®re non compostable dans le bac", "bac trop plein", "bac trop sec", "bac trop humide", "composteur cass√©", "manque de structurant"] %>
              <%= f.submit "Signaler une anomalie ...", class: "signaler anomalie" %>
            <% end %>
          </div>
          <div class="message-form">
            <%= simple_form_for @notification, html: { class: "message-form-flex"} do |f| %>
              <%= f.input :notification_type, as: :string, input_html: { value: "message", type:"hidden" }%>
              <%= f.input :content, as: :text, placeholder: "votre message...",  class: "message-form-content-input"%>
              <%= f.submit "Envoyer", class: "mini-btn mini-banana-btn signaler" %>
            <% end %>
          </div>
        <% end %>
        <div class="message-board">
          <% @notifications.each do |notification| %>
            <% if notification.notification_type == "welcome" || notification.notification_type == "depot" || notification.notification_type == "anomalie" || notification.notification_type == "message" %>
              <% if notification.user_id != current_user.id || notification.notification_type == "anomalie" %>
                <div class="notif-block">
                  <div class="notif-filler"></div>
                  <div class="notif-with-name">
                    <div class="notif-username name-right">
                      <% if notification.notification_type == "anomalie" %>
                        <% if notification.resolved %>
                          anomalie r√©solue par votre r√©f√©rent‚Ä¢e pr√©f√©r√©‚Ä¢e !
                        <% else %>
                          <% if current_user.role == "r√©f√©rent" %>
                            <div class="resolving-btn">
                              <%= link_to("#{current_user.first_name.capitalize}, cliquez ici si l'anomalie est r√©solue ! üôÇ", resolved_path(notification), method: :post) %>
                            </div>
                          <% end %>
                        <% end %>
                        ü§ø
                      <% else %>
                        <%= notification.user.first_name %>
                      <% end %>
                    </div>
                    <div class="notification-card notification-card-current-user <%= notification.notification_type %>">
                      <div class="notif-content"><p><%= notification.content %></p></div>
                      <div class="notif-since">Il y a <%= distance_of_time_in_words(Time.now, notification.created_at) %></div>
                    </div>
                  </div>
                </div>
              <% else %>
                <div class="notif-block">
                  <div class="notif-with-name">
                    <div class="notif-username name-left">Moi</div>
                    <div class="notification-card <%= notification.notification_type %>">
                      <% if notification.notification_type == "depot" %>
                        <div class="notif-content"><p>Je viens de faire un d√©pot ! üëå </p></div>
                      <% else %>
                        <div class="notif-content"><p><%= notification.content %></p></div>
                      <% end %>
                      <div class="notif-since">Il y a <%= distance_of_time_in_words(Time.now, notification.created_at) %></div>
                    </div>
                  </div>
                  <div class="notif-filler"></div>
                </div>
              <% end %>
            <% end %>
          <% end %>
        </div>
      <% end %>
    <% end %>
  </div>
  <div class="composteur-right">
    <% if user_signed_in? == false %>
      <div class="composteur-registration-form">
        <%= render "devise/registrations/new" %>
      </div>
    <% end %>
    <div class="les-referents white-bg">
      <div class="becoming-or-not-referent">
        <% if user_signed_in? %>
          <% if current_user.role != "admin" %>
            <% if current_user.composteur_id == @composteur.id && current_user.role == nil %>
              <div class="dropdown-form-referent">
                <div class="referent-action-toggle">
                  <% if current_user.notifications.where(notification_type: "demande-r√©f√©rent").count < 1 %>
                    <%= link_to("devenir r√©f√©rent", referent_path(@composteur), method: :post) %>
                  <% end %>
                </div>
              </div>
              <!-- link to me d√©sinscrire --->
            <% elsif current_user.composteur_id == @composteur.id && current_user.role == "r√©f√©rent" %>
              <div class="dropdown-form-referent">
                <div class="referent-action-toggle">
                  <%= link_to("ne plus √™tre r√©f√©rent", non_referent_path(@composteur), method: :post) %>
                </div>
              </div>
            <% end %>
          <% end %>
        <% end %>
      </div>
      <h3>r√©f√©rent‚Ä¢e‚Ä¢s</h3>
      <%= link_to "C'est quoi √™tre r√©f√©rent‚Ä¢e ?", "https://uncomposteurici.gitbook.io/poubellesbattle/convaincre-son-assemblee-generale-de-copropriete-dinstaller-un-composteur-en-pied-dimmeuble/le-role-de-referent-e-composteur", class: "ref-quoi" %>
      <% if @referents.count != 0 %>
        <% @referents.each do |referent| %>
          <div class="referent-card">
          <!-- <div class="star">‚≠êÔ∏è</div> -->
            <!-- <div class="referent-profile"> -->
              <% if user_signed_in? %>
                <% if current_user.role == "admin" %>
                  <div class="mini-btn"><%= link_to("retirer ce r√©f√©rent", non_referent_path(@composteur, referent_id: referent), method: :post) %></div>
                <% end %>
              <% end %>
              <h5><%= referent.first_name %></h5>
              <% if referent.ok_phone %>
                <p><%= referent.phone_number %></p>
              <% end %>
              <% if referent.ok_mail %>
                <%= mail_to referent.email, "‚úâÔ∏è", subject: "Votre composteur m'int√©resse !", class: "email-button" %>
              <% end %>
              <% if user_signed_in? %>
                <% if current_user.role == "r√©f√©rent" && current_user == referent %>
                  <%= simple_form_for(@notification) do |f| %>
                    <%= f.input :notification_type, as: :string, input_html: { value: "message-ref", type:"hidden" }%>
                    <%= f.input :content, as: :text, placeholder: "modifier mon message de pr√©sentation..." %>
                    <%= f.submit "Enregistrer", class: "message-form-ref" %>
                  <% end %>
                  <% if @messages_notifications != nil && referent.notifications.where(notification_type: "message-ref") != [] %>
                    <div class="notification-card <%= @messages_notifications.notification_type %>">
                      <p><%= referent.notifications.where(notification_type: "message-ref").last.content %></p>
                    </div>
                  <% end %>
                <% else %>
                  <% if @messages_notifications != nil && referent.notifications.where(notification_type: "message-ref") != [] %>
                    <div class="notification-card <%= @messages_notifications.notification_type %>">
                      <p><%= referent.notifications.where(notification_type: "message-ref").last.content %></p>
                    </div>
                  <% end %>
                <% end %>
              <% end %>
              <%# end %>
            <!-- </div> -->
          </div>
        <% end %>
      <% else %>
        <div class="referent-card no-ref">Pas de r√©f√©rent sur ce composteur pour l'instant ..
        <!-- put here contact form -->
        </div>
      <% end %>
    </div>

    <div class="les-messages">
      <h3 class="marg-vert-bottom">message de l'agglo</h3>
      <% if @messages_admin %>
        <div class="message-date"><%= l @messages_admin.created_at, format: ("Le %d %B %Y") %></div>
        <div class="message-content"><%= @messages_admin.content %></div>
      <% end %>
    </div>
  </div>
</div>
